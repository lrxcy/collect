# 使用自定義的protocol做TCP傳輸
### TCP封包組成
```
TCP/IP    | 介紹                           | 網路設備 | 通訊協定
應用層     | 任何的通訊協定、功能都會在此被定義  | 無      | 所有影用層的通訊協定在此定義
傳輸層     | 提供端點之間的Port用來做連結與確認 | Switch  | TCP、UDP
網路層     | 用來定義兩端點的IP位置           ｜ Router  | IP、ICMP
資料連結層  | 定義兩端點的MAC地址              |         | ARP、RARP
實體層     | 又稱物理層、走光電訊號(硬體)       |         |
```
### L2封包內容
首先，對於資料傳輸層(L2)的封包，有以下內容
> 00 18 23 3c 86 c6 00 18 23 3c d7 fb 08 00
其中前8個Byte是來源MAC，後8個Byte是目的地MAC，最後兩個Byte則是定義採用哪一種網路協定
```
來源mac            | 目的mac           | type
00 18 23 3c 86 c6 | 00 18 23 3c d7 fb | 08 00
```

### L3封包內容
有定義出，每一個byte在做什麼
```
0-3 : 版本
4-7 : 首部長度
8-13 : 區分服務
14-15 : 顯示擁塞通告
16-18/19-31 : 全長
```
已封包內容如下來看~
> 45 00 00 3b 58 ac 00 00 ff 06 eb 0b c0 a8 7b 5a c0 a8 7b 59
```
Type&Header | Service | 封包總長 | 識別碼 | 可否切割 | 存活時間 | 協定 | Check Sum | 來源IP	      | 目的IP	     |Data
45          | 00      | 00 3b   | 58 ac | 00 00  | ff      | 06  | eb 0b     | c0 a8 7b 5a | c0 a8 7b 59  |
```
- Type&Header: 該欄位佔1 Byte，主要由兩個欄位組成(Type、Header)
    - Type欄位佔4bit: 通訊雙方使用的Type必須一致，捼使用IPv4，其欄位的值為4
    - Header欄位佔4bit: 用來定義網路層封包長度，但由於網路層封包長度不固定，因此該欄位最小值為5最大值為15。其中長度的計算為5*4=20Byte，即網路層長度為20
- Service: 該欄位佔1 Byte，一般的情況下都不使用這個欄位。只有在使用VoIP時才會被指用，因此預設值為00
- 封包總長: 該欄位佔2 Byte，用來表示整個封包長度(但不含 資料連結層L2)，即L3~L5的長度
- 識別碼: 該欄位佔2 Byte，用來識別該連線的唯一識別碼(或是有過大的風包會被切割時，可以用該識別碼，識別切個的封包有哪些)
- 可否切割：該欄位佔 2 Byte，若封包過大時，則會定義該封包可否被切格為等量的小封包進行傳送
- 存活時間：該欄位佔 2 Byte，為了避免封包在網路中永遠存在（例如陷入路由環路），封包經過的每個路由器都將此欄位減1，當此欄位為0時，封包不再向下傳送並被丟棄，最大值是255
- 協定：該欄位占 1 Byte，用來定義了該封包資料區使用的協定

### L4傳輸層封包內容
有定義出，每一個byte在做什麼
```
0-3 : 資料偏移
4-6 : 保留 0 0 0
7(NS)、8(CWR)、9(ECE)、10(URG)、11(ACK)、12(PSH)、13(RST)、14(SYN)、15(FIN)
16-31 : 窗口大小
```
已封包內容如下來看~
> 35 81 01 f6 18 73 eb a1 52 d0 28 e7 50 18 02 00 b2 34 00 00
```
來源Port | 目的Port | 序列號       | 確認碼       | flag  | window size | check sum | 緊急指標
35 81   | 01 f6   | 18 73 eb a1 | 52 d0 28 e7 | 50 18 | 02 00       | b2 34     | 00 00
```
- 序列號：用來識別該連線的編號，每增加一條連線，該序號就會+1
- 確認碼：期望收到的資料的開始序列號。也即已經收到的資料的位元組長度加1
- flag：該欄位由三個值組成
    - 第一個數值為定義整個傳輸層(L4)的封包長度，其中長度的計算為5*4=20 (Byte) 即網路層長度為20
    - 資料偏移（4位元長）—以4位元組為單位計算出的資料段開始位址的偏移值
    - 保留（3位元長）—須置0
    - 標誌符（9位元長）
        - NS—ECN-nonce
        - CWR—Congestion Window Reduced
        - ECE—ECN-Echo有兩種意思，取決於SYN標誌的值
        - URG—為1表示高優先級封包，緊急指標欄位有效
        - ACK—為1表示確認號欄位有效
        - PSH—為1表示是帶有PUSH標誌的資料，指示接收方應該儘快將這個報文段交給應用層而不用等待緩衝區裝滿
        - RST—為1表示出現嚴重差錯。可能需要重現建立TCP連接。還可以用於拒絕非法的報文段和拒絕連接請求
        - SYN—為1表示這是連接請求或是連接接受請求，用於建立連接和使順序號同步
        - FIN—為1表示傳送方沒有資料要傳輸了，要求釋放連接



# refer:
- https://dotblogs.com.tw/leo_codespace/2019/03/29/203853


# online packetor
- http://packetor.com/