# 前言
網路傳播分成4種，根據通訊對象的數量來分類通訊方式

# 單播(Unicast)
1. 這個字組合了代表1的`Uni`以及有投放意思的`Cast`，從這一點就可以了解，這是一對一通訊。過去的電話，就是單播通訊的典型案例
```
e.g.
單播:一對一通訊
就像是學生與老師，或是學生之間的一對一對話
```
UniCast，單播，指網路中一個節點與另一個節點之間需要建立一個單獨的數據通道，從一個節點發出的信息只被一個節點收到，這種傳送方式稱為單播
> 即網路中從源向目的地轉發單播流量的過程，`IP位址與節點(主機)一一對應`，單播流量地址唯一。每個節點必須分別對需要訪問的節點發送單獨的查詢，
而`被訪問的節點`必須向`每個節點`發送所申請的數據包拷貝

# 廣播(Broadcast)
1. `Broadcast`含有`播放`的意思，代表從一台主機向所有連接的主機傳送資料。廣播通訊的典型案例就是播放電視，將訊號同時傳送給不特定的多數人
2. 另外，只有能收到電視訊號的範圍，才可以收看電視，而電腦網路的廣播也一樣，有限定的通訊範圍
3. 廣播可以通訊的範圍(廣播可以傳送的範圍)，就稱作廣播網域(broadcast domain)
```
e.g.
廣播:全部的電腦(限同一個資料連結內)
就像是在朝會上，校長對全校師生的談話
```
MultiCast，即多播，指網路中一個節點發出的信息被多個節點(一組節點)接受。這種技術用於多媒體應用、多用戶交流(聊天室)、軟件分發等
> 相比於傳統的單播(UniCast)，在子網路內實現MultiCast較為簡單，跨越子網時需要Route、Gateway等設備支持

# 群播(Multicast)
1. 群播和廣播一樣，可以對多個主機進行通訊。可是通訊對象僅限於特定群組
2. 群播的典型案例是視訊會議，就像多個人在不同場所參加這個會議
3. 在這種視訊會議中，一台主機會限定特定多數的連接對象，同時進行通訊
4. 假如用廣播通訊進行視訊會議，所有可以使用視訊會議的主機都會連動，這樣就無法掌握在哪裡、有誰參加視訊會議
```
e.g.
群播:在特定群組內的通訊
就像是在全校當中，只通知一年一班的同學，或通知各學會
```
BroadCast，即廣播，指網路中一個節點發出的信息被網路中的所有可能(通常指特定的子網)的節點所接受
> 網路設備簡單地將它接收到的任何廣播報文副本轉發到除了豹紋到達的接口以外的每個接口

# 任播(Anycast)
1. `任播`其名稱中有`Any(任何人)`，顧名思義，這是對特定多台主機詢問`有誰可以回覆!`的結構。
2. 這種通訊方式和群播一樣，由一台主機向特定多台主機傳送資料，但是他的行為與群播不同
3. 在任播通訊中，從特定多台主機挑選一個在網路上擁有最佳條件的對象，只對該對象傳送資料
4. 一般來說，這台被選定的特定主機，會以單播方式回傳資料，後續的通訊只在這該主機之間進行
```
e.g.
任播:特定群組的任何一台電腦
就像老師想找一年一班的1位學生來幫忙發資料，學生之中，有1個人採取行動
```
AnyCast，任播，或稱泛播，指IPV6協議中一個發送方同最近的一組接受方之間的通信
1. BGP AnyCast就是利用一個(或多個)AS號碼在不同的地區廣播相同的一個IP段。即不同地區若干個AS號碼廣播同一個IP(段)
2. 廣義來看，AnyCast與MultiCast對同一種類型的數據流同時存在多個接收者
3. 狹義而論，AnyCast又有著UniCast的唯一性，因為每一個單獨的IP session都能夠找到唯一的源主機和目標主機(最終通信雙方唯一)
> 在AnyCast的環境下，同時存在多個有效的數據包接收端，但具體一個特定IP數據包而言，僅有一個接收端主機收到了此數據包
> AnyCast利用BGP的尋路原則，短的AS PATH會選成最優路徑(BGP尋路原則之一)，從而優化了訪問速度
> 即可多個不同服務器使用相同的IP地址(該地址即這一組主機的共享單播地址)的一種技術。當發送方發送報文給這個共享單播地址時，報文會根據路由協議路由到這一組主機中離發送方最近的一台，所以這技術也稱作負載均衡

# AnyCast技術特點
AnyCast的定義：當一個單播地址被分配到多於一個的接口上(即目的地址不是唯一)時，發到該接口的報文會被網路路由到路由協議量測的"最近"的目標街口(某個節點)上
1. AnyCast允許源節點向一組目標節點中的一個節點發送數據包，而這個節點由路由系統選擇，對源節點透明
2. 同時，路由系統選擇"最近"的節點為源節點提供服務，從而在一定程度上為源節點提供了更好的服務，也減輕了網路負載
3. AnyCast分布的服務節點共享相同的IP地址，同時在IP層進行透明的服務定位，使得各種網路服務特別是應用層服務具有更強的透明性，如DNS(Domain Name Server)，用戶不需要特殊配置也不用擔心訪問的是哪一台DNS

# 路由系統帶來的兩項優點
1. 減弱了DDoS對用戶帶來的影響，當AnyCast組中某一個成員或者幾個成員受到攻擊時，負責request轉發的路由器可以根據各個組員的Response time來決定request應該轉往哪一個成員上，而受到攻擊的成員由於沒有response，所以request就不會被轉發到此節點，同時AnyCast提供服務訪問透明性，組成員之間也相對難收到DDoS攻擊
2. 減弱了網路壅塞給end-user的影響，當AnyCast的某些組員處在壅塞的網段時，他的response time就會較長，request可以被轉發到response time可以較快的成員那裡，而不會讓end-user感覺到

# AnyCast應用場景
AnyCast主要應用於大範圍的DNS部署，CDN數據緩存，數據中心等。
- 疑惑
1. 在AnyCast網路中，多個主機同用一個IP?
   1. 每一個節點主機處在不同的地理位置，相互之間不在同一個廣播內;所以，把所有主機配置成相同的IP位址並不會引起IP衝突
   2. 在僅僅配置相同IP之外，還需要借助BGP協議進行地址宣告，通過BGP各站點向Internet宣告相同的AnyCast IP地址
2. 具有多條到達目的的路徑，且具有相同AnyCast IP地址的Prefix，數據包如何做到就近路由選址呢?
   1. 當用戶的DNS(數據)請求到達運營商的的寬帶路由器以後，運營商的路由器會根據BGP的選路原則到達目的地的最優路徑，在用戶寬帶運營商和DNS服務器Internet運營相同的情況下，最終會以IGP metric為關鍵因素來決定哪個DNS服務器會給用戶提供服務。而IGP的Metric某種程度上就是物理距離的代表，從而實現就近原則

### 場景一: 基於IP Anycast+BGP的DNS部署
- 背景: 假設部署三個DNS服務器站點，地點分別在北京、上海及廣州，且服務於全國的DNS解析
- 常規方案: 為了實現三個DNS load balacner，通常會考慮到使用硬件負載均衡設備
  - 方案缺陷:
    1. 網路流量瓶頸：所有的流量都需要先通過load balancer，而硬件設備本身的吞吐量決定了整個網路環境的吞吐量
    2. 高昂的硬件成本：為了實現全國的流量負載均衡，需要極大吞吐量的硬件設備，從而大大提高了部署成本
- AnyCast方案：
- 優點: 通過AnyCast技術，無需要借助任何第三方負載均衡器，就可以輕鬆達到負載均衡的效果，同時還提供了冗余和高可靠性
通過配置三個DNS站點的服務器IP為相同IP，例如1.1.1.1/32;然後通過各個站點的BGP對互聯網宣告1.1.1.0/24的網段
以上步驟完成以後，互聯網路由表針對1.1.1.1/24會有三個不同的出口路由器，分別是北京、上海、廣州
> 全國用戶最終會根據DNS服務器的距離遠近來判斷使用哪一個DNS服務器做域名解析。從DNS角度來說，正因為不同的地理位置用戶會根據就近路由判斷，從而選擇不同的DNS服務器，最終會使用三台DNS服務器達到負載均衡的效果。即便其中某一個節點出現故障，業務也會立即遷移到其他可用的節點上，避免網路服務故障


### 場景二: 防範DDoS攻擊
- 背景: DDoS為分佈式阻斷式攻擊，旨在透過大量的網路請求癱瘓服務，進而影響到正常使用者
> DDoS攻擊最關鍵是把所有地理位置分散的小流量最終匯集成一個巨大的流量從而發起攻擊
- DDoS分為三種攻擊: 流量型攻擊、連接型攻擊、特殊協議缺陷;其中又以流量型攻擊最為常見
  - e.g. 當大規模的請求湧入時，會佔用營運商核心MPLS網路帶寬，同時這種syn flooding也會給客戶網路造成短時間的癱瘓
  - 以NTP協議為例，NTP基於C/S模式，客戶發起NTP時間查詢申請，服務器響應NTP查詢。假設有成千上萬的殭屍主機，紛紛偽造數據包並發送
    - 偽造源地址: 1.2.3.4 # 此地址為真正需要攻擊的地址
    - 目標地址: 全球各個NTP服務器地址 # 大批量提供響應的節點
  - 當全球各地的NTP服務器收到此查詢之後，他會把查詢結果發回給真正的被攻擊者1.2.3.4，此時IP地址為1.2.3.4的受害者收到全世界的NTP服務器發送過來的數據包時，其有限的帶寬鏈路就很容易產生壅塞並造成服務中斷。收到的DDoS攻擊流量=虛假數據包發送數量x全世界NTP服務器的數量

- AnyCast防範DDoS攻擊:
在AnyCast環境下，由於多個地理位置不同的主機同時使用一個IP位址。因此，DDoS攻擊流量在穿越運營商路由器時，路由器會根據地理位置遠近，把數據包路由到距離源站最近的受害者主機站點，從而間接又再次分散整個DDoS流量

### 場景三: 大型企業CDN部署
AnyCast在大型企業中也常用於CDN部署，採用AnyCast技術為用戶提供距離用戶最近的Cache Server，可大大提高了用戶的服務體驗。在全球建立了多個數據中心，憑藉於AnyCast的高冗余性，任何一個數據中心出現網路、系統故障。均不會影響end-user

### 場景四: 對於時間延遲敏感度高的業務Server
而出現體針對https/tcp等對時間延遲敏感的協議，會因用戶位置異動而造成網路不穩。如果數據中心相對固定，可能會間接導致用戶體驗下降
- 透過全球部署解決問題
  - 在全球有相關業務的地理位置部署小型數據中心，讓所有小型業務中心和總部數據中心保持長期穩定的TCP session
  - 當相對於總部遠的用戶訪問時，TCP連接實際是發送ㄉㄜˋ用戶當地的小數據中心，從而降低請求延遲
  - 當用戶訪問服務時，DNS解析會返回該地小型數據中心的IP

> 運營商會根據就近原則路由用戶數據到最近的小型數據中心，從而達到了優化延遲的目的

# AnyCast總結
- 優點
1. AnyCast可以零成本實現負載均衡，同時對於客戶端而言是透明的，且無視流量大小
2. AnyCast是非常有效的DDoS防禦措施，採用了逐層分解的思想;
3. 部署AnyCast可以獲得設備的高冗余性和可用性，即當任意的節點異常時，可自動路由到就近的節點
4. AnyCast可以適用於無連接UDP或有連接的TCP
5. 基於AnyCast的就近原則，很大程度上提升了客戶端的響應速度
- 缺點
1. AnyCast嚴重依賴於BGP的選路原則，在整個Internet網路拓樸複雜的情況下，可能導致路由器沒法達到最優選擇


# notes:
目前主流是AnyCast，目標是用docker快速建置一個AnyCast的測試環境


# refer:
- https://www.cnblogs.com/itzgr/p/10192799.html
- https://github.com/kd7lxl/docker-anycast-service-discovery.git