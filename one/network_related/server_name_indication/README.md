# Server Name Indication 伺服器名稱指示

伺服器名稱指示(英語:Server Name Indication，簡稱SNI)是一個擴充的TLS電腦聯網協定，在該協定下，在握手過程開始時，用戶端即要告訴伺服器端要連接的主機名稱。
1. 這允許伺服器在相同的IP位置和TCP埠號上呈現多個憑證
2. 並且因此允許在相同的IP位址上提供多個安全(HTTPS)網站(或其他任何基於TLS的服務)
3. 而不需要所有這些站點使用相同的憑證。
4. 它與HTTP/1.1基於名稱的虛擬主機的概念相同，但是用於HTTPS。所需的主機名未加密，因此竊聽者可以檢視請求的網站。

為了使SNI協定起作用，絕大多數存取者必須使用實現它的Web瀏覽器。
> 使用為實現SNI瀏覽器的用戶將被提供預設憑證，因此很可能會收到憑證警告。

# 問題的背景
當進行TLS連接時，用戶端從Web伺服器請求數位憑證。伺服器一旦傳送憑證，用戶就會檢查這個憑證，並將其嘗試連接的平稱與憑證中包含的名稱進行對比。
如果Web傳送到伺服器的數位憑證可以在伺服器端符合，則進行正常連接
反之，伺服器會警告用戶差異並中止連線，可能潛藏`中間人攻擊(Man-in-the-middle attack; MITM)`的風險。
不過，某些用戶繞過警告繼續進行連接，由用戶承擔信任憑證以及連接的責任。

一個憑證覆蓋多個主機名是可以做到的。X.509 v3規範引入了subjectAltName欄位，該欄位允許一個憑證指定多個網域名稱，並在通用名和subjectAltName欄位中使用萬用字元。

然而，由於缺少所有名稱的完整清單，可能很難甚至不可能獲得涵蓋伺服器將負責的所有名稱的單個憑證。
負責多個主機名的伺服器可能需要為每個名稱(或一組名稱)提供不同的憑證。

`基於名稱的虛擬主機`允許多個DNS主機名由同一IP位置上的單個伺服器(通常為Web伺服器)代管。
為了實現這一點，伺服器使用用戶端提供的主機名作為協定的一部分(對於HTTP，名稱顯示在主機頭)
但是，當使用HTTPS時，TLS握手發生在伺服器看到任何HTTP頭之前
因此，伺服器不可能使用HTTP主機頭中的資訊來決定呈現哪個憑證，並且因此只有由統一憑證覆蓋的名稱才能由同一IP位置提供

意味著，基於安全瀏覽來說，HTTPS伺服器只能是每個IP位址服務一個網域名稱(或一組網域名稱)
為每個站點分配單獨的IP位址會增加代管成本，因為對IP位址的請求必須為"區域網際網路註冊管理機構"提供證據而且"現在IPv4位址已用盡。
其結果是，許多網站在IPv4上使用安全通訊上都受到限制，而IPv6位址空間因未用完，所以不受此問題影響

# SNI 如何解決此問題
SNI通過讓用戶端重送虛擬網域名稱，作為TLS協商的一部分來解決此問題
這使伺服器能夠提前選擇正確的虛擬網域名稱，並向瀏覽器提供包含正確名稱的憑證。
因此，對於實現SNI的用戶端和伺服器，具有單個IP位址的伺服器可以在取得公共憑證不現實的情況下提供一組網域名稱
> SNI在2003年6月的RFC 3546，<傳輸層安全(TLS)擴充>加入到IETF的Internet RFCs中。最新版本的標準是RFC 6066

# 安全性
由於SNI資訊並非加密的，允許審查者區分出"真實"和"虛假"的服務或者辨識出使用者存取的網站網域名稱
現已被國家(如 防火長城)用於`網際網路審查`

# 域前置
> 主條目：域前置

域前置通過SNI中使用虛假無害的網域名稱資訊，已經被TLS加密的應用層才使用真實的網域名稱資訊，
將真實流量隱藏在看似無害的流量中，從而使審查者無法區別出來。

Google和CloudFront曾啟用該技術的支援，之後停止了，被認為是受到俄羅斯政府的壓力，防止Telegram利用該技術來規避審查

# 加密伺服器名稱只是(ESNI)
作為TLS的標準擴充實現，TLS 1.3將通過支援加密SNI以解決這問題

# refer
1. https://zh.wikipedia.org/wiki/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%8D%E7%A7%B0%E6%8C%87%E7%A4%BA
2. https://zh.wikipedia.org/wiki/%E5%8C%BA%E5%9F%9F%E4%BA%92%E8%81%94%E7%BD%91%E6%B3%A8%E5%86%8C%E7%AE%A1%E7%90%86%E6%9C%BA%E6%9E%84
3. https://zh.wikipedia.org/wiki/%E4%B8%AD%E9%97%B4%E4%BA%BA%E6%94%BB%E5%87%BB

# 補充：中間人攻擊(Man-in-the-middle attack; MITM)
中間人攻擊在密碼學和電腦安全領域中，是指攻擊者與通訊的兩端分別建立獨立的聯絡，並交換其所收到的資料，使通訊的兩端認為他們正在通過一個私密的連接與對方直接對話。
但事實上，整個對談都被攻擊者完全控制。在中間人攻擊中，攻擊者可以攔截通訊雙方的通話，並插入新的內容。
例如，在一個未加密的Wi-Fi無線存取點的接受範圍內的中間人攻擊者，可以將自己作為一個中間人插入這個網路

一個中間人攻擊能成功的前提條件是，攻擊者能將自己偽裝成每一個參與對談的終端，並且不會被其他的終端識破。
中間人攻擊是一個(缺乏)相互認證的攻擊。
大多數的加密協定都專門加入一些特數的認證方法以阻止中間人攻擊，例如SSL協定，可以驗證參與通訊的一方或雙方，使用的憑證是否由CA頒發，並且能執行雙向身份認證。

# 需要透個一個安全的通道做額外的傳輸
與`鏈鎖協定`不同，所有能抵禦中間人攻擊的加密系統都需要通過一個`安全通道`來傳輸或交換一些額外的資訊。
為了滿足不同安全通道的不同安全需求，許多`金鑰交換協定`已經被研究出來

# 攻擊範例
https://github.com/xpn/mitm